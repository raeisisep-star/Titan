<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Module Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
</head>
<body class="bg-gray-900 text-white p-8">
    <h1 class="text-3xl font-bold mb-6">üß™ Trading Module Test</h1>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
            <h2 class="text-xl font-bold mb-4">Test Results</h2>
            <div id="test-results" class="space-y-2"></div>
            
            <button id="run-test" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded mt-4">
                üöÄ Test Trading Module
            </button>
        </div>
        
        <div>
            <h2 class="text-xl font-bold mb-4">Console Log</h2>
            <div id="console-log" class="bg-gray-800 p-4 rounded-lg h-64 overflow-y-auto font-mono text-sm"></div>
        </div>
    </div>
    
    <!-- Chart Test -->
    <div class="mt-8">
        <h2 class="text-xl font-bold mb-4">Chart Test</h2>
        <div class="bg-gray-800 p-4 rounded-lg">
            <canvas id="test-chart" width="800" height="400"></canvas>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEl = document.getElementById('console-log');
            const colors = {
                'error': '#ef4444',
                'success': '#10b981', 
                'warning': '#f59e0b',
                'info': '#3b82f6'
            };
            
            logEl.innerHTML += `<div style="color: ${colors[type]}">[${timestamp}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function addResult(test, success, message) {
            const resultsEl = document.getElementById('test-results');
            const icon = success ? '‚úÖ' : '‚ùå';
            const color = success ? 'text-green-400' : 'text-red-400';
            
            resultsEl.innerHTML += `<div class="flex items-center ${color}">
                <span class="mr-2">${icon}</span>
                <span class="font-medium">${test}:</span>
                <span class="ml-2 text-gray-300">${message}</span>
            </div>`;
        }
        
        async function testChart() {
            log('üìä Testing Chart.js functionality...', 'info');
            
            try {
                if (typeof Chart === 'undefined') {
                    addResult('Chart.js', false, 'Chart.js not loaded');
                    log('‚ùå Chart.js not available', 'error');
                    return false;
                }
                
                addResult('Chart.js', true, 'Chart.js loaded successfully');
                log('‚úÖ Chart.js available', 'success');
                
                // Test chart creation
                const ctx = document.getElementById('test-chart');
                if (!ctx) {
                    addResult('Canvas Element', false, 'Canvas not found');
                    return false;
                }
                
                addResult('Canvas Element', true, 'Canvas found');
                log('‚úÖ Canvas element available', 'success');
                
                // Create test chart
                const testChart = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['1', '2', '3', '4', '5'],
                        datasets: [{
                            label: 'Test Data',
                            data: [10, 20, 15, 25, 30],
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#ffffff' } }
                        },
                        scales: {
                            y: { ticks: { color: '#ffffff' } },
                            x: { ticks: { color: '#ffffff' } }
                        }
                    }
                });
                
                addResult('Chart Creation', true, 'Test chart created successfully');
                log('‚úÖ Test chart created successfully', 'success');
                return true;
                
            } catch (error) {
                addResult('Chart Creation', false, error.message);
                log('‚ùå Chart creation error: ' + error.message, 'error');
                return false;
            }
        }
        
        async function testTradingModule() {
            log('üöÄ Starting Trading Module Test...', 'info');
            
            try {
                // Test Chart.js first
                const chartWorking = await testChart();
                if (!chartWorking) {
                    log('‚ùå Chart test failed, skipping module test', 'error');
                    return;
                }
                
                // Test Module Loader
                if (!window.moduleLoader) {
                    await loadScript('/static/modules/module-loader.js?v=' + Date.now());
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                if (window.moduleLoader) {
                    addResult('Module Loader', true, 'Available');
                    log('‚úÖ Module Loader available', 'success');
                } else {
                    addResult('Module Loader', false, 'Not available');
                    log('‚ùå Module Loader not available', 'error');
                    return;
                }
                
                // Test Trading Module Loading
                log('üìä Loading Trading Module...', 'info');
                const tradingModule = await window.moduleLoader.loadModule('trading');
                
                if (tradingModule) {
                    addResult('Trading Module', true, `Loaded v${tradingModule.version}`);
                    log(`‚úÖ Trading Module loaded (v${tradingModule.version})`, 'success');
                } else {
                    addResult('Trading Module', false, 'Failed to load');
                    log('‚ùå Trading Module failed to load', 'error');
                    return;
                }
                
                // Test Trading API
                log('üåê Testing Trading API...', 'info');
                try {
                    const response = await axios.get('/api/trading/advanced/advanced');
                    if (response.data.success) {
                        addResult('Trading API', true, 'API working correctly');
                        log('‚úÖ Trading API working', 'success');
                    } else {
                        addResult('Trading API', false, 'API returned error');
                        log('‚ùå Trading API error', 'error');
                    }
                } catch (apiError) {
                    addResult('Trading API', false, apiError.message);
                    log('‚ùå Trading API error: ' + apiError.message, 'error');
                }
                
                log('üéâ Trading Module test completed!', 'success');
                
            } catch (error) {
                log('‚ùå Test failed: ' + error.message, 'error');
                addResult('General Test', false, error.message);
            }
        }
        
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // Event Listeners
        document.getElementById('run-test').addEventListener('click', testTradingModule);
        
        // Auto-run test
        window.addEventListener('load', () => {
            setTimeout(testTradingModule, 1000);
        });
    </script>
</body>
</html>