<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تست قیمت‌های واقعی</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">🧪 تست قیمت‌های واقعی ارزهای دیجیتال</h1>
        
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">وضعیت API</h2>
            <div id="status" class="text-gray-400">در حال بارگذاری...</div>
        </div>

        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-bold mb-4">قیمت‌های Real-time</h2>
            <div id="prices" class="space-y-3">
                <div class="text-gray-400">در حال دریافت...</div>
            </div>
        </div>

        <div class="mt-6 bg-blue-900/50 rounded-lg p-4">
            <p class="text-sm">
                ℹ️ این صفحه مستقیماً از <code class="bg-gray-700 px-2 py-1 rounded">/api/market/prices</code> 
                قیمت‌ها را می‌گیرد. اگر قیمت‌های واقعی نمایش داده شد، یعنی API کار می‌کند و مشکل از browser cache است.
            </p>
        </div>
    </div>

    <script>
        async function fetchPrices() {
            const statusEl = document.getElementById('status');
            const pricesEl = document.getElementById('prices');
            
            try {
                statusEl.innerHTML = '<span class="text-yellow-400">🔄 در حال دریافت از API...</span>';
                
                const response = await fetch('/api/market/prices?symbols=BTC,ETH,ADA,DOT,LINK');
                const data = await response.json();
                
                if (data.success && data.data) {
                    statusEl.innerHTML = '<span class="text-green-400">✅ API کار می‌کند!</span>';
                    
                    let html = '';
                    for (const [symbol, coin] of Object.entries(data.data)) {
                        const changeClass = coin.price_change_percentage_24h >= 0 ? 'text-green-400' : 'text-red-400';
                        const changeIcon = coin.price_change_percentage_24h >= 0 ? '▲' : '▼';
                        
                        html += `
                            <div class="flex items-center justify-between p-4 bg-gray-700 rounded-lg">
                                <div>
                                    <div class="font-bold text-lg">${coin.name} (${coin.symbol})</div>
                                    <div class="text-sm text-gray-400">Market Cap: $${coin.market_cap.toLocaleString()}</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-xl">$${coin.current_price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    <div class="${changeClass} text-sm">
                                        ${changeIcon} ${coin.price_change_percentage_24h >= 0 ? '+' : ''}${coin.price_change_percentage_24h.toFixed(2)}%
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    pricesEl.innerHTML = html;
                    
                    // Add timestamp
                    const timestampEl = document.createElement('div');
                    timestampEl.className = 'text-sm text-gray-400 mt-4';
                    timestampEl.textContent = `آخرین به‌روزرسانی: ${new Date(data.timestamp).toLocaleString('fa-IR')}`;
                    pricesEl.appendChild(timestampEl);
                    
                } else {
                    statusEl.innerHTML = '<span class="text-red-400">❌ خطا در دریافت داده</span>';
                    pricesEl.innerHTML = `<div class="text-red-400">خطا: ${data.error || 'Unknown error'}</div>`;
                }
                
            } catch (error) {
                statusEl.innerHTML = '<span class="text-red-400">❌ خطا در اتصال به API</span>';
                pricesEl.innerHTML = `<div class="text-red-400">خطا: ${error.message}</div>`;
                console.error('Error fetching prices:', error);
            }
        }
        
        // Fetch immediately
        fetchPrices();
        
        // Refresh every 60 seconds
        setInterval(fetchPrices, 60000);
    </script>
</body>
</html>
