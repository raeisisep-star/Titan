# =============================================================================
# TITAN Trading System - Enhanced Nginx Configuration for zala.ir
# =============================================================================
# Based on: infra/nginx-ssl-strict.conf
# Customized for: www.zala.ir production
# Date: 2025-10-20
# Phase: 4 - SSL Full (strict)
# =============================================================================

# HTTP to HTTPS Redirect
server {
    listen 80;
    listen [::]:80;
    server_name zala.ir www.zala.ir;
    
    # Security: Don't reveal server version
    server_tokens off;
    
    # Redirect all HTTP traffic to HTTPS
    return 301 https://$host$request_uri;
}

# Rate limiting zones (define before server blocks)
# Auth endpoints: IP-based (5 req/s) + username-based (10 req/min)
map $request_body $login_key {
    default $binary_remote_addr;
    ~"username\":\"([^\"]+)" $1;
}
limit_req_zone $binary_remote_addr zone=auth_zone:10m rate=5r/s;
limit_req_zone $login_key zone=auth_user:10m rate=10r/m;
limit_req_zone $binary_remote_addr zone=api_zone:10m rate=20r/s;

# Cloudflare IP ranges for real_ip
set_real_ip_from 173.245.48.0/20;
set_real_ip_from 103.21.244.0/22;
set_real_ip_from 103.22.200.0/22;
set_real_ip_from 103.31.4.0/22;
set_real_ip_from 141.101.64.0/18;
set_real_ip_from 108.162.192.0/18;
set_real_ip_from 190.93.240.0/20;
set_real_ip_from 188.114.96.0/20;
set_real_ip_from 197.234.240.0/22;
set_real_ip_from 198.41.128.0/17;
set_real_ip_from 2400:cb00::/32;
set_real_ip_from 2606:4700::/32;
set_real_ip_from 2803:f800::/32;
set_real_ip_from 2405:b500::/32;
set_real_ip_from 2405:8100::/32;
set_real_ip_from 2a06:98c0::/29;
set_real_ip_from 2c0f:f248::/32;
real_ip_header CF-Connecting-IP;

# HTTPS Server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name zala.ir www.zala.ir;

    # Root directory for static files
    root /tmp/webapp/Titan/public;
    index index.html;

    # Security: Don't reveal server version
    server_tokens off;
    
    # Client request body size limit
    client_max_body_size 1m;
    
    # Client body buffer size
    client_body_buffer_size 128k;

    # =============================================================================
    # SSL Configuration (Cloudflare Origin Certificate)
    # =============================================================================
    
    # Cloudflare Origin Certificate and Private Key
    # Using full chain for OCSP stapling support
    ssl_certificate     /etc/ssl/cloudflare/zala.ir.origin.fullchain.crt;
    ssl_certificate_key /etc/ssl/cloudflare/zala.ir.origin.key;
    
    # Modern SSL protocols (TLS 1.3 and 1.2 only - strict)
    ssl_protocols TLSv1.3 TLSv1.2;
    
    # Prefer server ciphers for better security
    ssl_prefer_server_ciphers on;
    
    # Strong cipher suites (TLS 1.3 first, then secure TLS 1.2)
    # TLS 1.3 ciphers (managed by OpenSSL automatically)
    ssl_ciphers 'TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256:TLS_CHACHA20_POLY1305_SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:HIGH:!aNULL:!MD5:!3DES:!DES:!RC4:!PSK:!SRP:!CAMELLIA';
    
    # SSL session settings (performance optimization)
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:10m;
    ssl_session_tickets off;  # Disable for better security
    
    # OCSP Stapling (enabled - using Cloudflare Origin CA certificate)
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/ssl/cloudflare/origin_ca_rsa_root.pem;
    
    # DNS resolvers for OCSP (Cloudflare DNS)
    resolver 1.1.1.1 1.0.0.1 valid=300s;
    resolver_timeout 5s;

    # =============================================================================
    # Security Headers
    # =============================================================================
    
    # üîç DIAGNOSTIC HEADER - Verify this server block is active
    add_header X-Titan-Config "zala-ssl-enhanced-v2" always;
    
    # HSTS (HTTP Strict Transport Security)
    # Tells browsers to always use HTTPS for this domain
    # max-age: 1 year, includeSubDomains: apply to all subdomains, preload: submit to HSTS preload list
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    
    # X-Frame-Options: Prevent clickjacking attacks
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # X-Content-Type-Options: Prevent MIME type sniffing
    add_header X-Content-Type-Options "nosniff" always;
    
    # X-XSS-Protection: Enable browser XSS protection
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Referrer-Policy: Control referrer information
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Content-Security-Policy (Report-Only mode for testing)
    add_header Content-Security-Policy-Report-Only "default-src 'self'; img-src 'self' data: https:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self' https://www.zala.ir; frame-ancestors 'self';" always;
    
    # Permissions-Policy (disable dangerous features)
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;

    # =============================================================================
    # Logging
    # =============================================================================
    
    access_log /var/log/nginx/zala-access.log;
    error_log /var/log/nginx/zala-error.log;

    # =============================================================================
    # API Proxy (Backend)
    # =============================================================================
    
    # Authentication endpoints with strict rate limiting
    location /api/auth/login {
        # Dual rate limiting: IP + username
        limit_req zone=auth_zone burst=10 nodelay;
        limit_req zone=auth_user burst=5 nodelay;
        limit_req_status 429;
        
        # Backend runs on port 5000
        proxy_pass http://127.0.0.1:5000;
        
        # HTTP version for proxy
        proxy_http_version 1.1;
        
        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Preserve original host and IP information
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Security headers
        add_header X-Titan-Config "zala-ssl-enhanced-v3" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Cache-Control "no-store, no-cache, must-revalidate" always;
    }
    
    # Other auth endpoints (register, logout, refresh)
    location /api/auth/ {
        limit_req zone=auth_zone burst=10 nodelay;
        limit_req_status 429;
        
        # Backend runs on port 5000
        proxy_pass http://127.0.0.1:5000;
        
        # HTTP version for proxy
        proxy_http_version 1.1;
        
        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Preserve original host and IP information
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        
        # Bypass cache for WebSocket connections
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts (adjust based on API response times)
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffer settings
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
        
        # Security headers (MUST be repeated in location blocks!)
        add_header X-Titan-Config "zala-ssl-enhanced-v2" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        
        # Cache control for API responses
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
    }
    
    # General API endpoints with moderate rate limiting
    location /api/ {
        limit_req zone=api_zone burst=30 nodelay;
        limit_req_status 429;
        
        # Backend runs on port 5000
        proxy_pass http://127.0.0.1:5000;
        
        # HTTP version for proxy
        proxy_http_version 1.1;
        
        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Preserve original host and IP information
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        
        # Bypass cache for WebSocket connections
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts (adjust based on API response times)
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffer settings
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
        
        # Security headers (MUST be repeated in location blocks!)
        add_header X-Titan-Config "zala-ssl-enhanced-v3" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        
        # Cache control for API responses
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
    }

    # =============================================================================
    # Static Files (Frontend)
    # =============================================================================
    
    # Main location - serve static files or fallback to index.html (SPA)
    location / {
        try_files $uri $uri/ /index.html;
        
        # Security headers (MUST be repeated in location blocks!)
        add_header X-Titan-Config "zala-ssl-enhanced-v2" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        
        # Cache static HTML for 1 day
        expires 1d;
        add_header Cache-Control "public, immutable" always;
    }
    
    # Static assets (JS, CSS, images, fonts)
    # Aggressive caching for immutable assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        # Security headers (MUST be repeated in location blocks!)
        add_header X-Titan-Config "zala-ssl-enhanced-v2" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        
        expires 1y;
        add_header Cache-Control "public, immutable" always;
        
        # CORS headers for fonts (if needed)
        add_header Access-Control-Allow-Origin * always;
    }
    
    # Prevent serving hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # =============================================================================
    # Error Pages
    # =============================================================================
    
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    
    location = /404.html {
        internal;
    }
    
    location = /50x.html {
        internal;
    }

    # =============================================================================
    # Health Check Endpoint (for load balancers)
    # =============================================================================
    
    location /nginx-health {
        access_log off;
        
        # Security headers (MUST be repeated in location blocks!)
        add_header X-Titan-Config "zala-ssl-enhanced-v2" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        
        add_header Content-Type text/plain always;
        return 200 "healthy\n";
    }
}

# =============================================================================
# Configuration Notes
# =============================================================================
#
# Changes from previous configuration:
# 1. Added HSTS header with max-age=31536000, includeSubDomains, preload
# 2. Added security headers: X-Frame-Options, X-Content-Type-Options, X-XSS-Protection, Referrer-Policy
# 3. Added OCSP Stapling for better SSL performance
# 4. Optimized SSL session settings
# 5. Updated cipher suites to Mozilla Modern configuration
# 6. Fixed backend proxy port to 5000 (matches actual PM2 configuration)
# 7. Added proper WebSocket support
# 8. Enhanced logging paths
#
# To apply this configuration:
# 1. Backup current config:
#    sudo cp /etc/nginx/sites-available/zala /etc/nginx/sites-available/zala.backup.$(date +%Y%m%d_%H%M%S)
# 
# 2. Copy this file:
#    sudo cp /home/ubuntu/Titan/nginx-zala-ssl-enhanced.conf /etc/nginx/sites-available/zala
#
# 3. Test configuration:
#    sudo nginx -t
#
# 4. Reload Nginx:
#    sudo systemctl reload nginx
#
# 5. Run tests again:
#    cd /home/ubuntu/Titan && ./scripts/test-ssl-acceptance.sh
#
# =============================================================================
