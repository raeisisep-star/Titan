# ๐ ุฎูุงุตู ุงูุฏุงูุงุช ุฏุจุงฺฏ - ุฑุงูููุง ูุงุฑุณ

**ุชุงุฑุฎ:** 1404/07/29 (2025-10-20)  
**ูุดฺฉู:** ูุฏุฑูุง HSTS ู ุงููุช ุฏุฑ ูพุงุณุฎโูุง HTTP ููุงุด ุฏุงุฏู ููโุดููุฏ

---

## ๐ ูุถุนุช ูุนู

### โ ฺฉุงุฑูุง ุงูุฌุงู ุดุฏู ุชูุณุท ุดูุง:
- ฺฉุงููฺฏ Nginx ุฌุงฺฏุฒู ุดุฏ
- `nginx -t` ุจุฏูู ุฎุทุง ูพุงุณ ุดุฏ  
- `systemctl reload nginx` ุจุฏูู ูุดฺฉู ุงุฌุฑุง ุดุฏ

### โ ูุดฺฉู:
- ูุฏุฑ `Strict-Transport-Security` ุฏุฑ ูพุงุณุฎโูุง ูุณุช
- ูุฏุฑูุง ุงููุช (X-Frame-Options ู...) ุฏุฑ ูพุงุณุฎโูุง ูุณุช
- ุงู ุฏุฑ ุญุงู ุงุณุช ฺฉู ุฏุฑ ฺฉุงููฺฏ ุจุง ุฏุณุชูุฑ `always` ุชูุธู ุดุฏูโุงูุฏ

---

## ๐ ุงูุฏุงูุงุช ููุฑ (ฺฏุงู ุจู ฺฏุงู)

### ฺฏุงู 1๏ธโฃ: ุงุนูุงู ฺฉุงููฺฏ ุจูโุฑูุฒ ุดุฏู ุจุง ูุฏุฑ ุชุดุฎุต

ูู ฺฉ ูุฏุฑ ุชุดุฎุต (`X-Titan-Config`) ุจู ฺฉุงููฺฏ ุงุถุงูู ฺฉุฑุฏู ุชุง ุจูููู ฺฉุฏุงู server block ูุนุงู ุงุณุช.

```bash
# ฺฉูพ ฺฉุงููฺฏ ุฌุฏุฏ
sudo cp /home/ubuntu/Titan/nginx-zala-ssl-enhanced.conf /etc/nginx/sites-available/zala

# ุชุณุช ฺฉุงููฺฏ
sudo nginx -t

# ุฏุฑ ุตูุฑุช ูููู ุจูุฏูุ reload ฺฉู
sudo systemctl reload nginx
```

**ุฎุฑูุฌ ููุฑุฏ ุงูุชุธุงุฑ:**
```
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
```

---

### ฺฏุงู 2๏ธโฃ: ุงุฌุฑุง ุงุณฺฉุฑูพุช ุชุดุฎุต ุฎูุฏฺฉุงุฑ

ฺฉ ุงุณฺฉุฑูพุช ุขูุงุฏู ฺฉุฑุฏู ฺฉู ููู ฺุฒ ุฑู ฺฺฉ ูโฺฉูู:

```bash
cd /home/ubuntu/Titan
./scripts/diagnose-nginx.sh
```

**ุงู ุงุณฺฉุฑูพุช ฺู ฺุฒูุง ฺฺฉ ูโฺฉููุ**
- โ ูุถุนุช ุณุฑูุณ Nginx
- โ ูุงูโูุง ฺฉุงููฺฏ ู symlink
- โ ุชุฏุงุฎู ุฏุฑ server_name
- โ ูุฏุฑูุง ุฏุฑ ุชุณุช ูุญู (ุจุฏูู ฺฏุฐุฑ ุงุฒ Cloudflare)
- โ ูุฏุฑูุง ุฏุฑ ุชุณุช ุฎุงุฑุฌ (ุงุฒ ุทุฑู Cloudflare)
- โ ุฎุทุงูุง ุงุฎุฑ Nginx
- โ ูพุฑูุณุณโูุง worker

---

### ฺฏุงู 3๏ธโฃ: ุชุณุช ุฏุณุช ูุฏุฑ ุชุดุฎุต (ูููโุชุฑู ุชุณุช!)

```bash
# ุชุณุช ูุณุชูู ุจู Nginx (ุจุฏูู ฺฏุฐุฑ ุงุฒ Cloudflare)
curl -I -k --resolve www.zala.ir:443:127.0.0.1 https://www.zala.ir | grep -i "x-titan"
```

**ูุชุฌู ููุฑุฏ ุงูุชุธุงุฑ:**
```
x-titan-config: zala-ssl-enhanced-v2
```

**ุชูุณุฑ ูุชุงุฌ:**
- โ **ูุฏุฑ ููุงุด ุฏุงุฏู ุดุฏ:** ฺฉุงููฺฏ ูุนุงู ุงุณุช โ ุจุฑู ฺฏุงู 4
- โ **ูุฏุฑ ูุณุช:** server block ุงุดุชุจุงู ูุนุงู ุงุณุช โ ุจุฎุด ุนุจโุงุจ ุฑุง ุจุจู

---

### ฺฏุงู 4๏ธโฃ: ุชุณุช ูุฏุฑ HSTS ุจู ุตูุฑุช ูุญู

```bash
# ุชุณุช ูุฏุฑ HSTS (ูุณุชูู ุจู Nginx)
curl -I -k --resolve www.zala.ir:443:127.0.0.1 https://www.zala.ir | grep -i "strict-transport"
```

**ูุชุฌู ููุฑุฏ ุงูุชุธุงุฑ:**
```
strict-transport-security: max-age=31536000; includeSubDomains; preload
```

**ุชูุณุฑ ูุชุงุฌ:**
- โ **ูุฏุฑ ููุงุด ุฏุงุฏู ุดุฏ:** Nginx ุฏุฑุณุช ฺฉุงุฑ ูโฺฉูุฏ โ Cloudflare ุฑู ฺฺฉ ฺฉู
- โ **ูุฏุฑ ูุณุช (ุจุง ุงูฺฉู X-Titan-Config ูุณุช):** ูุดฺฉู ูพฺุฏูโุชุฑ ุงุณุช

---

### ฺฏุงู 5๏ธโฃ: ุชุณุช ุงุฒ ุจุฑูู (ุงุฒ ุทุฑู Cloudflare)

```bash
# ุชุณุช ุงุฒ ุทุฑู Cloudflare
curl -I https://www.zala.ir | grep -i "strict-transport"
```

**ุชูุณุฑ ูุชุงุฌ:**
- โ **ูุฏุฑ ูุณุช:** ููู ฺุฒ ฺฉุงุฑ ูโฺฉูู! ๐
- โ **ูุฏุฑ ูุณุช (ูู ุชู ุชุณุช ูุญู ุจูุฏ):** Cloudflare ุฏุงุฑู ูุฏุฑูุง ุฑู ุญุฐู ูโฺฉูู

---

## ๐ฏ ุณูุงุฑููุง ุงุญุชูุงู

### ุณูุงุฑู A: ูุฏุฑ X-Titan-Config ูุณุช

**ุนู:** ฺฉุงููฺฏ ุงุตูุงู ุงุนูุงู ูุดุฏู.

**ฺฺฉ ฺฉู:**
```bash
# symlink ุฏุฑุณุช ูุณุชุ
ls -la /etc/nginx/sites-enabled/ | grep zala

# server_name ุฏุฑุณุชูุ
grep "server_name" /etc/nginx/sites-available/zala

# ุชุฏุงุฎู ูุณุชุ
grep -r "default_server" /etc/nginx/sites-enabled/
```

**ุฑุงู ุญู:**
```bash
# restart ฺฉุงูู
sudo systemctl restart nginx

# ุฏูุจุงุฑู ุชุณุช ฺฉู
curl -I -k --resolve www.zala.ir:443:127.0.0.1 https://www.zala.ir | grep -i "x-titan"
```

---

### ุณูุงุฑู B: X-Titan-Config ูุณุชุ ูู HSTS ูุณุช

**ุนู:** ฺฉุงููฺฏ ูุนุงูู ูู ูุฏุฑูุง ุงุถุงูู ููโุดู.

**ุฑุงู ุญู:**
```bash
# restart ฺฉุงูู Nginx
sudo systemctl restart nginx

# ุตุจุฑ ฺฉู 2 ุซุงูู
sleep 2

# ุฏูุจุงุฑู ุชุณุช ฺฉู
curl -I -k --resolve www.zala.ir:443:127.0.0.1 https://www.zala.ir/ | grep -iE "(strict-transport|x-frame)"
```

---

### ุณูุงุฑู C: ูุญู ฺฉุงุฑ ูโฺฉููุ ูู ุงุฒ ุจุฑูู ูู

**ุนู:** Cloudflare ูุฏุฑูุง ุฑู ุญุฐู ูโฺฉูู.

**โ ุงู ุฑูุชุงุฑ ุทุจุนู!** Cloudflare ุงููุช ุฑู ุฏุฑ ูุงู edge ูุฏุฑุช ูโฺฉูู.

**ุฑุงู ุญู:**

1. **ุจุฑู ุฏุงุดุจูุฑุฏ Cloudflare:**
   - ุฏุงููู: zala.ir
   - ุจุฎุด: **SSL/TLS** โ **Edge Certificates**

2. **ูุนุงู ฺฉู HSTS ุฑู:**
   - ฺฏุฒูู: **HSTS (HTTP Strict Transport Security)** โ ุฑูุดู
   - ุชูุธูุงุช:
     - Max Age: **31536000** ุซุงูู (1 ุณุงู)
     - Include subdomains: โ
     - Preload: โ
     - No-Sniff Header: โ

3. **ุฏุฑ PR ุชูุถุญ ุจุฏู:**
   - ูุฏุฑูุง ุงููุช ุฏุฑ Cloudflare edge ูุฏุฑุช ูโุดู
   - ุงู ุฑูุด ูุงุจู ูุจูู ู ุญุช ุชุฑุฌุญ ุงุณุช

---

## ๐งช ุงุฌุฑุง ุชุณุชโูุง ุงุตูุงุญ ุดุฏู

ุจุนุฏ ุงุฒ ุญู ูุดฺฉูุ ุงู ุฑู ุงุฌุฑุง ฺฉู:

```bash
cd /home/ubuntu/Titan
./scripts/test-ssl-acceptance-fixed.sh
```

**ฺู ฺุฒูุง ุงุตูุงุญ ุดุฏูุ**
- โ Health endpoint: ุงูุชุธุงุฑ `{"ok": true}` ุฏุงุฑู ูู `{"data":{"status":"healthy"}}`
- โ Auth endpoint: ฺูุฏู ูุณุฑ ูุฎุชูู ุฑู ุงูุชุญุงู ูโฺฉูู
- โ ุชุณุช ุชุดุฎุต ุงุถุงูู ุดุฏู (ุชุณุช 9): ฺฺฉ ูโฺฉูู X-Titan-Config ูุณุช ุง ูู
- โ ููู ูุฏุฑูุง ูพุงุณุฎ ุฑู ูุดูู ูุฏู ุจุฑุง ุฏุจุงฺฏ

---

## ๐ ุฏุณุชูุฑุงุช ุณุฑุน

```bash
# 1. ุงุนูุงู ฺฉุงููฺฏ ุฌุฏุฏ
sudo cp /home/ubuntu/Titan/nginx-zala-ssl-enhanced.conf /etc/nginx/sites-available/zala
sudo nginx -t && sudo systemctl reload nginx

# 2. ุงุฌุฑุง ุชุดุฎุต ุฎูุฏฺฉุงุฑ
cd /home/ubuntu/Titan
./scripts/diagnose-nginx.sh

# 3. ฺฺฉ ุณุฑุน ูุฏุฑูุง (ูุญู)
curl -I -k --resolve www.zala.ir:443:127.0.0.1 https://www.zala.ir | grep -iE "(x-titan|strict-transport)"

# 4. ฺฺฉ ุณุฑุน ูุฏุฑูุง (ุฎุงุฑุฌ)
curl -I https://www.zala.ir | grep -i "strict-transport"

# 5. restart ฺฉุงูู Nginx
sudo systemctl restart nginx

# 6. ุงุฌุฑุง ุชุณุชโูุง ุงุตูุงุญ ุดุฏู
./scripts/test-ssl-acceptance-fixed.sh
```

---

## ๐ ูุณุฑ ุชุตููโฺฏุฑ

```
ุชุณุช X-Titan-Config ุจู ุตูุฑุช ูุญู
โ
โโ โ ูุณุช
โ   โโ> [ุณูุงุฑู A] server block ุงุดุชุจุงู ูุนุงูู
โ       โโ> symlinkุ server_nameุ ุชุฏุงุฎูโูุง ุฑู ฺฺฉ ฺฉู
โ
โโ โ ูุณุช
    โ
    โโ> ุชุณุช HSTS ุจู ุตูุฑุช ูุญู
        โ
        โโ โ ูุณุช
        โ   โโ> [ุณูุงุฑู B] ูุฏุฑูุง ุงุถุงูู ููโุดู
        โ       โโ> Nginx ุฑู restart ฺฉู
        โ
        โโ โ ูุณุช
            โ
            โโ> ุชุณุช HSTS ุงุฒ ุจุฑูู (ุงุฒ ุทุฑู Cloudflare)
                โ
                โโ โ ูุณุช
                โ   โโ> [ุณูุงุฑู C] Cloudflare ุฏุงุฑู ุญุฐู ูโฺฉูู
                โ       โโ> HSTS ุฑู ุฏุฑ Cloudflare ูุนุงู ฺฉู
                โ       โโ> ุงู ุทุจุน ู ูุงุจู ูุจููู โ
                โ
                โโ โ ูุณุช
                    โโ> ๐ ููููุช! ููู ฺ ฺฉุงุฑ ูโฺฉูู
```

---

## โ ูุนุงุฑูุง ููููุช

ูโุฏูู ููู ฺุฒ ฺฉุงุฑ ูโฺฉูู ููุช ฺฉู:

1. โ ูุฏุฑ X-Titan-Config ุฏุฑ ุชุณุช ูุญู ููุงุด ุฏุงุฏู ุจุดู
2. โ ูุฏุฑ HSTS ุฏุฑ ุชุณุช ูุญู ููุงุด ุฏุงุฏู ุจุดู
3. โ ูุฏุฑูุง ุงููุช ุฏุฑ ุชุณุช ูุญู ููุงุด ุฏุงุฏู ุจุดู
4. โ HSTS ุฏุฑ ุฏุงุดุจูุฑุฏ Cloudflare ูุนุงู ุดุฏู ุจุงุดู
5. โ ุงุณฺฉุฑูพุช ุชุณุช ุญุฏุงูู 7 ุงุฒ 9 ุชุณุช ุฑู ูพุงุณ ฺฉูู
6. โ ุฎุทุง ุฏุฑ ูุงฺฏ Nginx ูุจุงุดู (ุจู ุฌุฒ ูุดุฏุงุฑ OCSP stapling)

---

## ๐ ูุงูโูุง ูุฑุชุจุท

- **ฺฉุงููฺฏ ุจูโุฑูุฒ ุดุฏู:** `/home/ubuntu/Titan/nginx-zala-ssl-enhanced.conf` โฌ๏ธ ุงู ุฑู apply ฺฉู
- **ุฑุงูููุง ุชุดุฎุต:** `/home/ubuntu/Titan/NGINX_HEADER_DIAGNOSTIC.md`
- **ุงุณฺฉุฑูพุช ุชุดุฎุต:** `/home/ubuntu/Titan/scripts/diagnose-nginx.sh` โฌ๏ธ ุงู ุฑู ุงุฌุฑุง ฺฉู
- **ุชุณุช ุงุตูุงุญ ุดุฏู:** `/home/ubuntu/Titan/scripts/test-ssl-acceptance-fixed.sh` โฌ๏ธ ุงู ุฑู ุงุฌุฑุง ฺฉู
- **ุฑุงูููุง ฺฉุงูู:** `/home/ubuntu/Titan/HEADER_DEBUG_INSTRUCTIONS.md`

---

## ๐ ฺฉุงุฑูุง ฺฉู ูู ุงูุฌุงู ุฏุงุฏู:

1. โ ูุฏุฑ ุชุดุฎุต `X-Titan-Config` ุจู ฺฉุงููฺฏ ุงุถุงูู ฺฉุฑุฏู
2. โ ุงุณฺฉุฑูพุช ุชุดุฎุต ุฎูุฏฺฉุงุฑ ุขูุงุฏู ฺฉุฑุฏู (`diagnose-nginx.sh`)
3. โ ุงุณฺฉุฑูพุช ุชุณุช ุงุตูุงุญ ุดุฏู ุขูุงุฏู ฺฉุฑุฏู (`test-ssl-acceptance-fixed.sh`)
4. โ ุฑุงูููุง ฺฉุงูู ูุงุฑุณ ู ุงูฺฏูุณ ููุดุชู
5. โ ุณูุงุฑููุง ูุฎุชูู ุนุจโุงุจ ุฑู ูุณุชูุฏ ฺฉุฑุฏู

---

## ๐ฏ ฺฉุงุฑูุง ฺฉู ุดูุง ุจุงุฏ ุงูุฌุงู ุจุฏุฏ:

### ููุฑ:
1. ุงุฌุฑุง ฺฏุงู 1: apply ฺฉุฑุฏู ฺฉุงููฺฏ ุฌุฏุฏ
2. ุงุฌุฑุง ฺฏุงู 2: ุงุณฺฉุฑูพุช ุชุดุฎุต ุฎูุฏฺฉุงุฑ
3. ุจุฑุฑุณ ูุชุงุฌ ู ุงุทูุงุน ุจู ูู

### ุฏุฑ ุตูุฑุช ูุงุฒ:
4. ุงุฑุณุงู ุฎุฑูุฌ `diagnose-nginx.sh` ุจุฑุง ุจุฑุฑุณ ุจุดุชุฑ
5. ุงุฌุฑุง ุชุณุชโูุง ุฏุณุช ุทุจู ุณูุงุฑู ูุดุฎุต ุดุฏู
6. ูุนุงูโุณุงุฒ HSTS ุฏุฑ Cloudflare (ุงฺฏุฑ ุณูุงุฑู C ุจุงุดู)

---

**ูููู ุจุงุดุฏ! ๐**

ุงฺฏุฑ ูุดฺฉู ูพุด ุงููุฏ ฺฉู ุชู ุงู ุฑุงูููุง ูุณุชุ ุฎุฑูุฌ `./scripts/diagnose-nginx.sh` ุฑู ุจุฑุงู ุจูุฑุณุช.
