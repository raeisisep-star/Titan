# 🔔 راهنمای کامل تب اطلاع‌رسانی - سیستم تایتان

## ✅ مشکلات برطرف شده

### 🎯 مشکل اصلی: خطای تست اتصال تلگرام
**علت:** endpoint‌های backend برای تست اطلاع‌رسانی‌ها وجود نداشت

### 🔧 راه‌حل‌های پیاده‌سازی شده:

#### 1️⃣ Backend Endpoints (5 endpoint جدید):
```javascript
POST /api/notifications/test-telegram    // تست اتصال تلگرام با Bot API
POST /api/notifications/test-email       // تست تنظیمات SMTP ایمیل
POST /api/notifications/test-discord     // تست Discord Webhook
GET  /api/alerts/settings                // دریافت تنظیمات اطلاع‌رسانی
PUT  /api/alerts/settings                // ذخیره تنظیمات اطلاع‌رسانی
```

#### 2️⃣ Frontend Fixes:
- اضافه شدن `type="button"` به تمام دکمه‌های تست (6 دکمه)
- جلوگیری از refresh صفحه هنگام کلیک روی دکمه‌های تست

---

## 📊 قابلیت‌های موجود در تب اطلاع‌رسانی

### 1. 📧 اعلان‌های ایمیل
**وضعیت:** ✅ تنظیمات معتبرسازی پیاده‌سازی شده

**تنظیمات مورد نیاز:**
- SMTP Host (مثلاً: `smtp.gmail.com`)
- SMTP Port (مثلاً: `587` برای TLS یا `465` برای SSL)
- SMTP Username (آدرس ایمیل شما)
- SMTP Password (رمز عبور یا App Password)
- From Email (ایمیل فرستنده)
- From Name (نام فرستنده)

**نحوه تست:**
1. فعال کردن سوئیچ "اعلان‌های ایمیل"
2. وارد کردن تنظیمات SMTP
3. کلیک روی "تست ارسال ایمیل"
4. بررسی پیام موفقیت/خطا

**نکته مهم:** 
- برای Gmail باید App Password بگیرید (نه رمز عبور اصلی)
- از https://myaccount.google.com/apppasswords

---

### 2. 💬 اعلان‌های تلگرام
**وضعیت:** ✅ کاملاً پیاده‌سازی و تست شده

**تنظیمات مورد نیاز:**
- **Bot Token:** توکن ربات تلگرام (از @BotFather)
- **Chat ID:** شناسه چت (از @userinfobot)
- **Parse Mode:** HTML یا Markdown

**مراحل دریافت Bot Token:**
1. رفتن به تلگرام و جستجوی @BotFather
2. ارسال دستور `/newbot`
3. انتخاب نام برای ربات
4. انتخاب username (باید به bot ختم شود)
5. دریافت توکن (مثال: `1234567890:ABCdefGHIjklMNOpqrsTUVwxyz`)

**مراحل دریافت Chat ID:**
1. جستجوی @userinfobot در تلگرام
2. ارسال `/start`
3. دریافت شناسه شما (مثال: `123456789`)

**نحوه تست:**
1. فعال کردن سوئیچ "اعلان‌های تلگرام"
2. وارد کردن Bot Token و Chat ID
3. کلیک روی "تست ارسال پیام"
4. بررسی دریافت پیام در تلگرام

**پیام تست شامل:**
```
🚀 TITAN Trading System

✅ تست ارتباط با تلگرام موفق بود!

🔔 اعلان‌های سیستم به درستی ارسال خواهند شد.

⏰ زمان: [تاریخ و ساعت فعلی]
```

---

### 3. 💬 اعلان‌های واتس‌اپ
**وضعیت:** ⚠️ شبیه‌سازی شده (نیاز به WhatsApp Business API دارد)

**تنظیمات مورد نیاز:**
- API Token (از سرویس‌دهنده WhatsApp Business)
- شماره تلفن
- Instance ID

**نکته:** پیاده‌سازی کامل نیاز به اشتراک WhatsApp Business API دارد

---

### 4. 📱 اعلان‌های پیامک (SMS)
**وضعیت:** ⚠️ شبیه‌سازی شده

**تنظیمات مورد نیاز:**
- **ارائه‌دهنده سرویس:**
  - کاوه نگار (Kavenegar)
  - فراپیامک (FaraPayamak)
  - IP Panel
- API Key (از پنل سرویس‌دهنده)
- شماره فرستنده

**نکته:** برای فعال‌سازی واقعی نیاز به خرید پنل پیامک دارید

---

### 5. 💬 اعلان‌های دیسکورد
**وضعیت:** ✅ کاملاً پیاده‌سازی و تست شده

**تنظیمات مورد نیاز:**
- **Webhook URL:** آدرس webhook از Discord
- **Username:** نام نمایشی ربات (مثلاً: TITAN Bot)

**مراحل دریافت Discord Webhook:**
1. باز کردن Discord و رفتن به سرور مورد نظر
2. کلیک راست روی کانال → Edit Channel
3. رفتن به تب "Integrations"
4. کلیک روی "Create Webhook"
5. انتخاب نام و کپی کردن Webhook URL
6. فرمت URL: `https://discord.com/api/webhooks/...`

**نحوه تست:**
1. فعال کردن سوئیچ "اعلان‌های دیسکورد"
2. وارد کردن Webhook URL
3. کلیک روی "تست ارسال پیام"
4. بررسی دریافت پیام در کانال Discord

**پیام تست شامل:**
- Embed با رنگ سبز
- عنوان: 🚀 TITAN Trading System
- متن تایید موفقیت
- زمان ارسال

---

### 6. 🔔 اعلان‌های درون‌برنامه‌ای
**وضعیت:** ✅ فعال

**تنظیمات:**
- **صدای اعلان:** پخش صدا هنگام دریافت اعلان
- **اعلان دسکتاپ:** نمایش نوتیفیکیشن در سیستم‌عامل
- **دکمه مجوز دسکتاپ:** درخواست مجوز نمایش اعلان‌ها

**نحوه فعال‌سازی اعلان‌های دسکتاپ:**
1. کلیک روی "مجوز دسکتاپ"
2. مرورگر درخواست مجوز می‌کند
3. کلیک روی "Allow"
4. دریافت یک اعلان تست

---

## 🎯 انواع اعلان‌های قابل تنظیم

### ✅ معاملات موفق
- اطلاع از اجرای موفق دستورات خرید/فروش
- شامل جزئیات معامله (قیمت، مقدار، سود/زیان)

### 📊 هشدارهای قیمت
- هشدار رسیدن به قیمت‌های هدف
- هشدار تغییرات شدید قیمت (مثلاً بیش از 5%)

### ❌ خطاهای سیستم
- اطلاع از خطاهای حیاتی
- مشکلات اتصال به صرافی‌ها
- خطاهای API

### 🤖 تجزیه‌وتحلیل AI
- نتایج تحلیل‌های هوش مصنوعی
- سیگنال‌های خرید/فروش
- هشدارهای ریسک

### 📈 گزارش‌های روزانه
- خلاصه عملکرد روزانه
- سود/زیان کل
- بهترین/بدترین معاملات

### 🔄 بروزرسانی‌ها
- اطلاع از بروزرسانی‌های سیستم
- اضافه شدن ویژگی‌های جدید

---

## 🧪 نحوه تست کامل سیستم اطلاع‌رسانی

### تست 1: تلگرام (اولویت اول)

1. **آماده‌سازی:**
   - ایجاد ربات تلگرام از @BotFather
   - دریافت Chat ID از @userinfobot

2. **تنظیمات:**
   ```
   Bot Token: [توکن دریافتی از BotFather]
   Chat ID: [شناسه دریافتی از userinfobot]
   Parse Mode: HTML
   ```

3. **تست:**
   - فعال کردن سوئیچ
   - وارد کردن اطلاعات
   - کلیک روی "تست ارسال پیام"
   - انتظار برای دریافت پیام در تلگرام (کمتر از 2 ثانیه)

4. **نتیجه مورد انتظار:**
   - نوتیفیکیشن سبز: "✅ تست تلگرام موفق! پیام ارسال شد"
   - دریافت پیام در تلگرام با محتوای فارسی

5. **خطاهای رایج:**
   - `Invalid bot token`: توکن اشتباه است
   - `Chat not found`: Chat ID اشتباه است یا باید ابتدا به ربات `/start` بزنید
   - `خطا در ارتباط`: مشکل در اتصال به اینترنت

---

### تست 2: Discord

1. **آماده‌سازی:**
   - ایجاد Webhook در کانال Discord
   - کپی کردن Webhook URL

2. **تنظیمات:**
   ```
   Webhook URL: https://discord.com/api/webhooks/[YOUR_WEBHOOK]
   Username: TITAN Bot
   ```

3. **تست:**
   - فعال کردن سوئیچ
   - وارد کردن Webhook URL
   - کلیک روی "تست ارسال پیام"

4. **نتیجه مورد انتظار:**
   - نوتیفیکیشن سبز: "✅ تست دیسکورد موفق! پیام ارسال شد"
   - دریافت Embed در کانال Discord

---

### تست 3: ایمیل

1. **آماده‌سازی (Gmail):**
   - رفتن به https://myaccount.google.com/apppasswords
   - ایجاد App Password جدید
   - کپی کردن رمز 16 رقمی

2. **تنظیمات:**
   ```
   SMTP Host: smtp.gmail.com
   SMTP Port: 587
   SMTP Username: your-email@gmail.com
   SMTP Password: [App Password 16 رقمی]
   From Email: your-email@gmail.com
   From Name: TITAN Trading System
   ```

3. **تست:**
   - فعال کردن سوئیچ
   - وارد کردن تنظیمات
   - کلیک روی "تست ارسال ایمیل"

4. **نتیجه مورد انتظار:**
   - نوتیفیکیشن سبز: "✅ تنظیمات ایمیل معتبر است"

**نکته:** در نسخه فعلی، فقط validation انجام می‌شود. ارسال واقعی ایمیل در نسخه بعدی پیاده‌سازی خواهد شد.

---

## 💾 ذخیره تنظیمات

### نحوه ذخیره:
1. انجام تنظیمات در هر بخش
2. کلیک روی دکمه "💾 ذخیره تنظیمات" در بالای صفحه
3. انتظار برای نوتیفیکیشن موفقیت

### محل ذخیره‌سازی:
- **Database:** PostgreSQL
- **Table:** `users`
- **Column:** `settings` (JSONB format)
- **Structure:**
  ```json
  {
    "notifications": {
      "telegram": {
        "enabled": true,
        "bot_token": "...",
        "chat_id": "...",
        "parse_mode": "HTML"
      },
      "email": { ... },
      "discord": { ... },
      "whatsapp": { ... },
      "sms": { ... },
      "inapp": { ... }
    }
  }
  ```

### بارگذاری خودکار:
- تنظیمات به صورت خودکار از database بارگذاری می‌شوند
- هنگام باز کردن تب اطلاع‌رسانی
- با استفاده از endpoint: `GET /api/alerts/settings`

---

## 🔍 عیب‌یابی

### مشکل 1: دکمه تست کار نمی‌کند
**علت:** احتمالاً صفحه refresh می‌شود  
**راه‌حل:** کش مرورگر را پاک کنید (`Ctrl + Shift + Delete`)

### مشکل 2: خطای "لطفاً ابتدا وارد سیستم شوید"
**علت:** Token احراز هویت منقضی شده  
**راه‌حل:** از سیستم خارج شوید و دوباره وارد شوید

### مشکل 3: تلگرام خطا می‌دهد "Invalid bot token"
**علت:** توکن اشتباه یا ناقص است  
**راه‌حل:** توکن کامل را از @BotFather کپی کنید (شامل `:` بعد از اعداد)

### مشکل 4: تلگرام خطا می‌دهد "Chat not found"
**علت:** Chat ID اشتباه یا ربات را استارت نزده‌اید  
**راه‌حل:** ابتدا به ربات خود `/start` بزنید، سپس تست کنید

### مشکل 5: Discord خطای 404 می‌دهد
**علت:** Webhook URL اشتباه یا حذف شده  
**راه‌حل:** Webhook جدید ایجاد کنید و URL صحیح را کپی کنید

### مشکل 6: تنظیمات ذخیره نمی‌شود
**علت:** احتمالاً خطا در ارتباط با backend  
**راه‌حل:** 
1. F12 → Console را باز کنید
2. خطاها را بررسی کنید
3. اسکرین‌شات بگیرید و به پشتیبانی ارسال کنید

---

## 📝 لاگ‌های مفید برای عیب‌یابی

### در Frontend (Console):
```javascript
// بررسی وجود instance
console.log(window.notificationsTab);

// تست دستی تلگرام
notificationsTab.testTelegramConnection();

// بررسی token
console.log(localStorage.getItem('titan_auth_token'));
```

### در Backend (PM2 Logs):
```bash
# مشاهده لاگ‌های زنده
pm2 logs titan-backend

# مشاهده 50 خط آخر
pm2 logs titan-backend --lines 50

# فقط خطاها
pm2 logs titan-backend --err
```

---

## ✅ چک‌لیست تکمیل تنظیمات

- [ ] تلگرام تست شده و کار می‌کند
- [ ] Discord تست شده و کار می‌کند
- [ ] تنظیمات ایمیل وارد شده (اگر نیاز است)
- [ ] اعلان‌های دسکتاپ مجوز دارد
- [ ] انواع اعلان‌های مورد نظر فعال شده
- [ ] تنظیمات ذخیره شده
- [ ] پس از refresh صفحه، تنظیمات باقی می‌ماند

---

## 🎯 مراحل بعدی (توسعه آینده)

1. **پیاده‌سازی کامل ارسال ایمیل**
   - استفاده از nodemailer
   - پشتیبانی از قالب‌های HTML
   - پیوست فایل

2. **ادغام WhatsApp Business API**
   - اتصال به سرویس‌دهنده‌های معتبر
   - ارسال پیام‌های متنی و تصویری

3. **پیاده‌سازی کامل SMS**
   - اتصال به کاوه نگار
   - اتصال به فراپیامک
   - اتصال به IP Panel

4. **اعلان‌های Real-time**
   - WebSocket برای اطلاع‌رسانی آنی
   - صدا و ویبره

5. **قالب‌های سفارشی**
   - امکان طراحی قالب اعلان
   - متغیرهای داینامیک

---

## 📞 پشتیبانی

اگر مشکلی دارید:
1. ابتدا این راهنما را کامل مطالعه کنید
2. بخش عیب‌یابی را بررسی کنید
3. لاگ‌های Console و Backend را چک کنید
4. اسکرین‌شات از خطاها بگیرید
5. به تیم پشتیبانی اطلاع دهید

---

**آخرین بروزرسانی:** 2025-10-16  
**نسخه:** 1.0.0  
**وضعیت:** ✅ تمام endpoint‌های اصلی پیاده‌سازی شده
