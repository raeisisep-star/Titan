<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITAN - Exchange Integration Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
</head>
<body class="bg-gray-900 text-white" dir="rtl">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="flex items-center justify-center mb-4">
                <i class="fas fa-exchange-alt text-6xl text-blue-500 ml-4"></i>
                <h1 class="text-5xl font-bold bg-gradient-to-r from-blue-400 to-green-400 bg-clip-text text-transparent">
                    TITAN Exchange Integration
                </h1>
            </div>
            <p class="text-gray-400 text-lg">تست یکپارچگی صرافی‌های واقعی - Phase 3 Completed</p>
            <div id="system-status" class="mt-4 inline-flex items-center px-4 py-2 rounded-full bg-green-900 text-green-300">
                <div class="w-2 h-2 bg-green-400 rounded-full ml-2 animate-pulse"></div>
                <span>سیستم آماده است</span>
            </div>
        </div>

        <!-- Quick Tests -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <button onclick="testSystemStatus()" class="bg-blue-600 hover:bg-blue-700 text-white p-6 rounded-lg transition">
                <i class="fas fa-heartbeat text-3xl mb-3"></i>
                <h3 class="text-xl font-bold">وضعیت سیستم</h3>
                <p class="text-blue-200">بررسی سلامت سیستم</p>
            </button>
            
            <button onclick="testConnections()" class="bg-purple-600 hover:bg-purple-700 text-white p-6 rounded-lg transition">
                <i class="fas fa-plug text-3xl mb-3"></i>
                <h3 class="text-xl font-bold">تست اتصالات</h3>
                <p class="text-purple-200">بررسی صرافی‌ها</p>
            </button>
            
            <button onclick="testMarketData()" class="bg-green-600 hover:bg-green-700 text-white p-6 rounded-lg transition">
                <i class="fas fa-chart-line text-3xl mb-3"></i>
                <h3 class="text-xl font-bold">داده‌های بازار</h3>
                <p class="text-green-200">قیمت‌های لحظه‌ای</p>
            </button>
        </div>

        <!-- Exchange Status -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <i class="fas fa-coins ml-2 text-yellow-500"></i>
                وضعیت صرافی‌ها
            </h2>
            <div id="exchange-status" class="text-center text-gray-400">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>در حال بارگذاری...</p>
            </div>
        </div>

        <!-- Market Data -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <i class="fas fa-chart-bar ml-2 text-blue-500"></i>
                داده‌های بازار - Bitcoin (BTC/USDT)
            </h2>
            <div id="market-data" class="text-center text-gray-400">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>در حال بارگذاری...</p>
            </div>
        </div>

        <!-- Advanced Features Demo -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Best Price Discovery -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-search-dollar ml-2 text-green-500"></i>
                    یافتن بهترین قیمت
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">نماد:</label>
                        <input type="text" id="price-symbol" value="BTCUSDT" 
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">نوع سفارش:</label>
                        <select id="price-side" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white">
                            <option value="buy">خرید</option>
                            <option value="sell">فروش</option>
                        </select>
                    </div>
                    <button onclick="findBestPrice()" 
                            class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded transition">
                        <i class="fas fa-search mr-2"></i>
                        یافتن بهترین قیمت
                    </button>
                    <div id="best-price-result" class="mt-4 text-sm"></div>
                </div>
            </div>

            <!-- Portfolio Value -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-wallet ml-2 text-purple-500"></i>
                    ارزش کل پرتفو
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">صرافی:</label>
                        <select id="portfolio-exchange" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white">
                            <option value="">همه صرافی‌ها</option>
                            <option value="mock">Mock Exchange</option>
                            <option value="binance">Binance</option>
                            <option value="coinbase">Coinbase Pro</option>
                            <option value="kucoin">KuCoin</option>
                        </select>
                    </div>
                    <button onclick="getPortfolioValue()" 
                            class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded transition">
                        <i class="fas fa-calculator mr-2"></i>
                        محاسبه ارزش پرتفو
                    </button>
                    <div id="portfolio-result" class="mt-4 text-sm"></div>
                </div>
            </div>
        </div>

        <!-- API Testing -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <i class="fas fa-code ml-2 text-red-500"></i>
                تست API دستی
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h4 class="text-lg font-bold mb-3">انتخاب API:</h4>
                    <div class="space-y-2">
                        <button onclick="testAPI('/api/exchange/status')" 
                                class="w-full text-left px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded transition">
                            GET /api/exchange/status
                        </button>
                        <button onclick="testAPI('/api/exchange/market-data/BTCUSDT?exchange=mock')" 
                                class="w-full text-left px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded transition">
                            GET /api/exchange/market-data/BTCUSDT
                        </button>
                        <button onclick="testAPI('/api/exchange/test-connections', 'POST')" 
                                class="w-full text-left px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded transition">
                            POST /api/exchange/test-connections
                        </button>
                    </div>
                </div>
                <div>
                    <h4 class="text-lg font-bold mb-3">نتیجه API:</h4>
                    <div id="api-result" 
                         class="bg-black rounded p-3 text-green-400 font-mono text-xs h-64 overflow-y-auto">
                        آماده برای تست API...
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-8 text-gray-400">
            <p>TITAN Trading System - Phase 3: Real Exchange Integration ✅</p>
            <p class="text-sm">Binance • Coinbase Pro • KuCoin • Smart Routing • Portfolio Management</p>
        </div>
    </div>

    <script>
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadExchangeStatus();
            loadMarketData();
        });

        async function testSystemStatus() {
            showLoading('system-status', 'در حال بررسی...');
            try {
                const response = await axios.get('/api/health');
                const status = document.getElementById('system-status');
                status.innerHTML = `
                    <div class="w-2 h-2 bg-green-400 rounded-full ml-2 animate-pulse"></div>
                    <span>سیستم سالم - ${response.data.system}</span>
                `;
                status.className = 'mt-4 inline-flex items-center px-4 py-2 rounded-full bg-green-900 text-green-300';
            } catch (error) {
                const status = document.getElementById('system-status');
                status.innerHTML = `
                    <div class="w-2 h-2 bg-red-400 rounded-full ml-2"></div>
                    <span>خطا در سیستم</span>
                `;
                status.className = 'mt-4 inline-flex items-center px-4 py-2 rounded-full bg-red-900 text-red-300';
            }
        }

        async function testConnections() {
            showLoading('exchange-status', 'در حال تست اتصالات...');
            try {
                const response = await axios.post('/api/exchange/test-connections');
                const results = response.data.data.results;
                
                let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">';
                for (const [exchange, result] of Object.entries(results)) {
                    const statusColor = result.success ? 'green' : 'red';
                    const icon = result.success ? 'check-circle' : 'times-circle';
                    
                    html += `
                        <div class="bg-gray-700 rounded p-4">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-${icon} text-${statusColor}-400 ml-2"></i>
                                <span class="font-bold">${exchange.toUpperCase()}</span>
                            </div>
                            <p class="text-sm text-gray-300">${result.message}</p>
                            ${result.data ? `<p class="text-xs text-gray-400 mt-1">Sandbox: ${result.data.sandbox ? 'Yes' : 'No'}</p>` : ''}
                        </div>
                    `;
                }
                html += '</div>';
                
                document.getElementById('exchange-status').innerHTML = html;
            } catch (error) {
                document.getElementById('exchange-status').innerHTML = `
                    <div class="text-red-400">
                        <i class="fas fa-exclamation-triangle mb-2"></i>
                        <p>خطا در تست اتصالات: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function testMarketData() {
            showLoading('market-data', 'در حال دریافت داده‌های بازار...');
            try {
                const response = await axios.get('/api/exchange/market-data/BTCUSDT?exchange=mock');
                const data = response.data.data.marketData;
                
                const html = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gray-700 rounded p-4 text-center">
                            <div class="text-2xl font-bold text-green-400">$${data.price.toLocaleString()}</div>
                            <div class="text-gray-400 text-sm">قیمت فعلی</div>
                        </div>
                        <div class="bg-gray-700 rounded p-4 text-center">
                            <div class="text-2xl font-bold text-blue-400">${data.changePercent24h.toFixed(2)}%</div>
                            <div class="text-gray-400 text-sm">تغییر 24 ساعته</div>
                        </div>
                        <div class="bg-gray-700 rounded p-4 text-center">
                            <div class="text-2xl font-bold text-yellow-400">$${data.high24h.toLocaleString()}</div>
                            <div class="text-gray-400 text-sm">بالاترین قیمت</div>
                        </div>
                        <div class="bg-gray-700 rounded p-4 text-center">
                            <div class="text-2xl font-bold text-purple-400">$${(data.volume24h / 1000000).toFixed(1)}M</div>
                            <div class="text-gray-400 text-sm">حجم معاملات</div>
                        </div>
                    </div>
                    <div class="mt-4 text-center text-gray-400 text-sm">
                        آخرین بروزرسانی: ${new Date(data.timestamp).toLocaleTimeString('fa-IR')}
                    </div>
                `;
                
                document.getElementById('market-data').innerHTML = html;
            } catch (error) {
                document.getElementById('market-data').innerHTML = `
                    <div class="text-red-400">
                        <i class="fas fa-exclamation-triangle mb-2"></i>
                        <p>خطا در دریافت داده‌های بازار: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadExchangeStatus() {
            try {
                const response = await axios.get('/api/exchange/status');
                // Auto-populate exchange status
                testConnections();
            } catch (error) {
                document.getElementById('exchange-status').innerHTML = `
                    <div class="text-red-400">
                        <p>خطا در بارگذاری وضعیت صرافی‌ها</p>
                    </div>
                `;
            }
        }

        async function loadMarketData() {
            // Auto-load market data
            testMarketData();
        }

        async function findBestPrice() {
            const symbol = document.getElementById('price-symbol').value;
            const side = document.getElementById('price-side').value;
            
            document.getElementById('best-price-result').innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال جستجو...';
            
            try {
                const response = await axios.post('/api/exchange/find-best-price', {
                    symbol,
                    side
                });
                
                const result = response.data.data;
                if (result.bestPrice) {
                    document.getElementById('best-price-result').innerHTML = `
                        <div class="bg-green-900 rounded p-3">
                            <div class="text-green-300 font-bold">بهترین قیمت ${side === 'buy' ? 'خرید' : 'فروش'}:</div>
                            <div class="text-green-400 text-lg">$${result.bestPrice.price.toLocaleString()}</div>
                            <div class="text-gray-400 text-sm">صرافی: ${result.bestPrice.exchange.toUpperCase()}</div>
                        </div>
                    `;
                } else {
                    document.getElementById('best-price-result').innerHTML = `
                        <div class="bg-yellow-900 rounded p-3 text-yellow-300">
                            هیچ قیمتی یافت نشد
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('best-price-result').innerHTML = `
                    <div class="bg-red-900 rounded p-3 text-red-300">
                        خطا: ${error.response?.data?.error || error.message}
                    </div>
                `;
            }
        }

        async function getPortfolioValue() {
            const exchange = document.getElementById('portfolio-exchange').value;
            
            document.getElementById('portfolio-result').innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال محاسبه...';
            
            try {
                const url = exchange 
                    ? `/api/exchange/portfolio-value?exchange=${exchange}`
                    : '/api/exchange/portfolio-value';
                    
                const response = await axios.get(url);
                const result = response.data.data;
                
                if (result.totalPortfolio) {
                    // Multiple exchanges
                    document.getElementById('portfolio-result').innerHTML = `
                        <div class="bg-purple-900 rounded p-3">
                            <div class="text-purple-300 font-bold">ارزش کل پرتفو:</div>
                            <div class="text-purple-400 text-lg">$${result.totalPortfolio.totalUsd.toLocaleString()}</div>
                            <div class="text-gray-400 text-sm mt-2">تفکیک صرافی‌ها:</div>
                            ${Object.entries(result.totalPortfolio.exchanges).map(([ex, data]) => 
                                `<div class="text-xs text-gray-300">${ex.toUpperCase()}: $${data.usd.toLocaleString()}</div>`
                            ).join('')}
                        </div>
                    `;
                } else {
                    // Single exchange
                    document.getElementById('portfolio-result').innerHTML = `
                        <div class="bg-purple-900 rounded p-3">
                            <div class="text-purple-300 font-bold">ارزش پرتفو در ${exchange.toUpperCase()}:</div>
                            <div class="text-purple-400 text-lg">$${result.totalValue.toLocaleString()}</div>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('portfolio-result').innerHTML = `
                    <div class="bg-red-900 rounded p-3 text-red-300">
                        خطا: ${error.response?.data?.error || error.message}
                    </div>
                `;
            }
        }

        async function testAPI(endpoint, method = 'GET') {
            document.getElementById('api-result').innerHTML = `> ${method} ${endpoint}\n\nدر حال ارسال درخواست...\n`;
            
            try {
                const response = method === 'POST' 
                    ? await axios.post(endpoint)
                    : await axios.get(endpoint);
                    
                document.getElementById('api-result').innerHTML = 
                    `> ${method} ${endpoint}\n\n` +
                    `Status: ${response.status} ${response.statusText}\n\n` +
                    `Response:\n${JSON.stringify(response.data, null, 2)}`;
            } catch (error) {
                document.getElementById('api-result').innerHTML = 
                    `> ${method} ${endpoint}\n\n` +
                    `Error: ${error.response?.status || 'Network Error'}\n\n` +
                    `Response:\n${JSON.stringify(error.response?.data || {message: error.message}, null, 2)}`;
            }
        }

        function showLoading(elementId, message) {
            document.getElementById(elementId).innerHTML = `
                <div class="text-center text-blue-400">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>${message}</p>
                </div>
            `;
        }

        // Auto-refresh market data every 30 seconds
        setInterval(loadMarketData, 30000);
    </script>
</body>
</html>