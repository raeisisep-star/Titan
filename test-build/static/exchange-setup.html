<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تنظیمات صرافی‌ها - تایتان</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
        }
        .status-connected { background-color: #10B981; }
        .status-error { background-color: #EF4444; }
        .status-pending { background-color: #F59E0B; }
        .status-not-configured { background-color: #6B7280; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="min-h-screen p-6">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold mb-2">
                    <i class="fas fa-exchange-alt text-blue-400 mr-3"></i>
                    تنظیمات صرافی‌ها
                </h1>
                <p class="text-gray-400">پیکربندی و تست اتصال به صرافی‌های مختلف</p>
            </div>

            <!-- Action Buttons -->
            <div class="mb-6 flex gap-4">
                <button onclick="testAllExchanges()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg">
                    <i class="fas fa-flask mr-2"></i>
                    تست تمام صرافی‌ها
                </button>
                <button onclick="loadExchangeStatus()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg">
                    <i class="fas fa-sync-alt mr-2"></i>
                    بروزرسانی وضعیت
                </button>
                <button onclick="loadMarketData()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg">
                    <i class="fas fa-chart-line mr-2"></i>
                    دریافت داده‌های بازار
                </button>
            </div>

            <!-- Exchange Status Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div id="exchange-cards">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Test Results -->
            <div class="bg-gray-800 rounded-lg border border-gray-700 mb-6">
                <div class="px-6 py-4 border-b border-gray-700">
                    <h3 class="text-lg font-semibold">نتایج تست</h3>
                </div>
                <div id="test-results" class="p-6">
                    <p class="text-gray-400 text-center">برای مشاهده نتایج، روی دکمه "تست تمام صرافی‌ها" کلیک کنید</p>
                </div>
            </div>

            <!-- Market Data -->
            <div class="bg-gray-800 rounded-lg border border-gray-700 mb-6">
                <div class="px-6 py-4 border-b border-gray-700">
                    <h3 class="text-lg font-semibold">داده‌های بازار</h3>
                </div>
                <div id="market-data" class="p-6">
                    <p class="text-gray-400 text-center">برای دریافت داده‌های بازار، روی دکمه مربوطه کلیک کنید</p>
                </div>
            </div>

            <!-- Configuration Guide -->
            <div class="bg-gray-800 rounded-lg border border-gray-700">
                <div class="px-6 py-4 border-b border-gray-700">
                    <h3 class="text-lg font-semibold">راهنمای پیکربندی</h3>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Binance -->
                        <div class="bg-gray-700 rounded-lg p-4">
                            <h4 class="font-semibold text-yellow-400 mb-3">
                                <i class="fab fa-bitcoin mr-2"></i>
                                Binance
                            </h4>
                            <div class="text-sm text-gray-300 space-y-2">
                                <p><strong>Testnet:</strong> https://testnet.binance.vision</p>
                                <p><strong>Production:</strong> https://api.binance.com</p>
                                <p><strong>نیاز به:</strong> API Key + Secret</p>
                                <p class="text-yellow-400">⚠️ ابتدا از testnet استفاده کنید</p>
                            </div>
                        </div>

                        <!-- Coinbase Pro -->
                        <div class="bg-gray-700 rounded-lg p-4">
                            <h4 class="font-semibold text-blue-400 mb-3">
                                <i class="fab fa-btc mr-2"></i>
                                Coinbase Pro
                            </h4>
                            <div class="text-sm text-gray-300 space-y-2">
                                <p><strong>Sandbox:</strong> api-public.sandbox.pro.coinbase.com</p>
                                <p><strong>Production:</strong> api.pro.coinbase.com</p>
                                <p><strong>نیاز به:</strong> API Key + Secret + Passphrase</p>
                                <p class="text-blue-400">💡 امنیت بالا</p>
                            </div>
                        </div>

                        <!-- KuCoin -->
                        <div class="bg-gray-700 rounded-lg p-4">
                            <h4 class="font-semibold text-green-400 mb-3">
                                <i class="fas fa-coins mr-2"></i>
                                KuCoin
                            </h4>
                            <div class="text-sm text-gray-300 space-y-2">
                                <p><strong>Sandbox:</strong> openapi-sandbox.kucoin.com</p>
                                <p><strong>Production:</strong> api.kucoin.com</p>
                                <p><strong>نیاز به:</strong> API Key + Secret + Passphrase</p>
                                <p class="text-green-400">✅ پشتیبانی کامل</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 p-4 bg-blue-900/20 rounded-lg border border-blue-700">
                        <h5 class="font-semibold text-blue-400 mb-2">
                            <i class="fas fa-info-circle mr-2"></i>
                            مراحل پیکربندی:
                        </h5>
                        <ol class="text-sm text-gray-300 space-y-1 list-decimal list-inside">
                            <li>ابتدا حساب testnet/sandbox در صرافی مورد نظر ایجاد کنید</li>
                            <li>API Key و Secret را دریافت کنید</li>
                            <li>کلیدها را در فایل .dev.vars قرار دهید</li>
                            <li>سرویس را restart کنید</li>
                            <li>از این صفحه تست اتصال انجام دهید</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        // Exchange Setup JavaScript
        let exchangeData = {};

        // Load exchange status on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadExchangeStatus();
        });

        // Load exchange configurations and status
        async function loadExchangeStatus() {
            try {
                const response = await axios.get('/api/trading/exchange/exchanges');
                
                if (response.data.success) {
                    exchangeData = response.data.data;
                    renderExchangeCards();
                    showAlert('وضعیت صرافی‌ها بروزرسانی شد', 'success');
                } else {
                    showAlert('خطا در دریافت وضعیت صرافی‌ها', 'error');
                }
            } catch (error) {
                console.error('Error loading exchange status:', error);
                showAlert('خطا در ارتباط با سرور', 'error');
            }
        }

        // Render exchange status cards
        function renderExchangeCards() {
            const container = document.getElementById('exchange-cards');
            container.innerHTML = '';

            for (const [exchangeId, config] of Object.entries(exchangeData)) {
                const statusClass = config.configured ? 
                    (config.hasApiKey && config.hasApiSecret ? 'status-connected' : 'status-error') : 
                    'status-not-configured';

                const card = `
                    <div class="bg-gray-700 rounded-lg p-4 border border-gray-600">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold">${config.name}</h4>
                            <span class="status-indicator ${statusClass}"></span>
                        </div>
                        <div class="text-sm text-gray-400 space-y-1">
                            <p><span class="text-gray-300">حالت:</span> ${config.sandbox ? 'تست' : 'تولید'}</p>
                            <p><span class="text-gray-300">API Key:</span> ${config.hasApiKey ? '✅' : '❌'}</p>
                            <p><span class="text-gray-300">API Secret:</span> ${config.hasApiSecret ? '✅' : '❌'}</p>
                            <p><span class="text-gray-300">Rate Limit:</span> ${config.rateLimit}/min</p>
                        </div>
                        <div class="mt-3 flex gap-2">
                            <button onclick="testSingleExchange('${exchangeId}')" 
                                    class="bg-blue-600 hover:bg-blue-700 text-xs px-3 py-1 rounded">
                                تست
                            </button>
                            <button onclick="getBalances('${exchangeId}')" 
                                    class="bg-green-600 hover:bg-green-700 text-xs px-3 py-1 rounded">
                                موجودی
                            </button>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            }
        }

        // Test all exchanges
        async function testAllExchanges() {
            const container = document.getElementById('test-results');
            container.innerHTML = '<p class="text-blue-400">در حال تست...</p>';

            try {
                const response = await axios.post('/api/trading/exchange/test-all');
                
                if (response.data.success) {
                    const results = response.data.data.results;
                    const summary = response.data.data.summary;
                    
                    let html = `
                        <div class="mb-4 p-4 bg-gray-700 rounded-lg">
                            <h4 class="font-semibold mb-2">خلاصه تست:</h4>
                            <div class="grid grid-cols-4 gap-4 text-center text-sm">
                                <div>
                                    <div class="text-2xl font-bold text-blue-400">${summary.total}</div>
                                    <div class="text-gray-400">کل</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-green-400">${summary.successful}</div>
                                    <div class="text-gray-400">موفق</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-red-400">${summary.failed}</div>
                                    <div class="text-gray-400">ناموفق</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-yellow-400">${summary.successRate}</div>
                                    <div class="text-gray-400">نرخ موفقیت</div>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-3">
                    `;
                    
                    for (const [exchange, result] of Object.entries(results)) {
                        const statusIcon = result.success ? '✅' : '❌';
                        const statusColor = result.success ? 'text-green-400' : 'text-red-400';
                        
                        html += `
                            <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg">
                                <div class="flex items-center">
                                    <span class="text-lg mr-3">${statusIcon}</span>
                                    <div>
                                        <span class="font-medium">${exchange}</span>
                                        <div class="text-sm ${statusColor}">${result.message}</div>
                                    </div>
                                </div>
                                ${result.data ? `
                                    <div class="text-xs text-gray-400">
                                        ${result.data.sandbox ? 'Testnet' : 'Production'}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                    container.innerHTML = html;
                    showAlert(`تست تکمیل شد - ${summary.successful}/${summary.total} موفق`, 'success');
                } else {
                    container.innerHTML = '<p class="text-red-400">خطا در تست صرافی‌ها</p>';
                    showAlert('خطا در تست صرافی‌ها', 'error');
                }
            } catch (error) {
                console.error('Error testing exchanges:', error);
                container.innerHTML = '<p class="text-red-400">خطا در ارتباط با سرور</p>';
                showAlert('خطا در ارتباط با سرور', 'error');
            }
        }

        // Test single exchange
        async function testSingleExchange(exchange) {
            try {
                const response = await axios.post('/api/trading/exchange/test-connection', {
                    exchange: exchange
                });
                
                const message = response.data.success ? 
                    `تست ${exchange} موفق بود` : 
                    `تست ${exchange} ناموفق: ${response.data.message}`;
                    
                showAlert(message, response.data.success ? 'success' : 'error');
            } catch (error) {
                showAlert(`خطا در تست ${exchange}`, 'error');
            }
        }

        // Get balances from exchange
        async function getBalances(exchange) {
            try {
                const response = await axios.get(`/api/trading/exchange/balances?exchange=${exchange}`);
                
                if (response.data.success) {
                    const balances = response.data.data;
                    let html = `<h4 class="font-semibold mb-3">موجودی ${exchange}:</h4>`;
                    
                    if (balances.length > 0) {
                        html += '<div class="space-y-2">';
                        balances.forEach(balance => {
                            html += `
                                <div class="flex justify-between items-center p-2 bg-gray-700 rounded">
                                    <span class="font-medium">${balance.asset}</span>
                                    <div class="text-right">
                                        <div class="text-sm">آزاد: ${balance.free}</div>
                                        <div class="text-sm text-gray-400">قفل: ${balance.locked}</div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    } else {
                        html += '<p class="text-gray-400">موجودی یافت نشد</p>';
                    }
                    
                    showModal('موجودی حساب', html);
                } else {
                    showAlert(`خطا در دریافت موجودی ${exchange}`, 'error');
                }
            } catch (error) {
                showAlert(`خطا در ارتباط برای ${exchange}`, 'error');
            }
        }

        // Load market data
        async function loadMarketData() {
            const container = document.getElementById('market-data');
            container.innerHTML = '<p class="text-blue-400">در حال دریافت داده‌ها...</p>';

            const symbols = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT'];
            const exchanges = ['mock', 'binance'];

            try {
                let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';

                for (const symbol of symbols) {
                    for (const exchange of exchanges) {
                        try {
                            const response = await axios.get(`/api/trading/exchange/market/${symbol}?exchange=${exchange}`);
                            
                            if (response.data.success) {
                                const data = response.data.data;
                                html += `
                                    <div class="bg-gray-700 rounded-lg p-4">
                                        <div class="flex items-center justify-between mb-2">
                                            <h5 class="font-semibold">${data.symbol}</h5>
                                            <span class="text-xs bg-blue-600 px-2 py-1 rounded">${data.exchange}</span>
                                        </div>
                                        <div class="space-y-1 text-sm">
                                            <div class="flex justify-between">
                                                <span class="text-gray-400">قیمت:</span>
                                                <span class="font-medium">$${data.price.toLocaleString()}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-400">تغییر 24 ساعته:</span>
                                                <span class="${data.changePercent24h > 0 ? 'text-green-400' : 'text-red-400'}">
                                                    ${data.changePercent24h > 0 ? '+' : ''}${data.changePercent24h}%
                                                </span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-400">حجم 24 ساعته:</span>
                                                <span>${data.volume24h.toLocaleString()}</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        } catch (error) {
                            console.error(`Error fetching ${symbol} from ${exchange}:`, error);
                        }
                    }
                }

                html += '</div>';
                container.innerHTML = html;
                showAlert('داده‌های بازار دریافت شد', 'success');
            } catch (error) {
                container.innerHTML = '<p class="text-red-400">خطا در دریافت داده‌های بازار</p>';
                showAlert('خطا در دریافت داده‌های بازار', 'error');
            }
        }

        // Show alert message
        function showAlert(message, type = 'info') {
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600', 
                warning: 'bg-yellow-600',
                info: 'bg-blue-600'
            };

            const alert = document.createElement('div');
            alert.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all transform translate-x-full`;
            alert.textContent = message;

            document.body.appendChild(alert);

            setTimeout(() => {
                alert.classList.remove('translate-x-full');
            }, 100);

            setTimeout(() => {
                alert.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(alert);
                }, 300);
            }, 3000);
        }

        // Show modal
        function showModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 max-w-2xl max-h-96 overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">${title}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">✕</button>
                    </div>
                    <div>${content}</div>
                </div>
            `;

            document.body.appendChild(modal);
        }
    </script>
</body>
</html>